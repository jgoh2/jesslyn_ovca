---
title: "Izar 2020 cohort1 DE Analysis"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = here::here())
knitr::opts_chunk$set(echo = TRUE)
```

```{r init}
# Load packages
library(tidyverse) # ggplot, dplyr, read_r (read_xlsx)
library(Matrix) # interact with sparse data
library(Seurat)
library(patchwork) # package to combine plots
library(glue)
library(beepr)
library(readxl)
library(ggplot2)
library(ggrepel) # for plot labelling

# Read in Seurat objects
cohort1 = readRDS("data/Izar_2020/jesslyn_cohort1_processed.RDS")
cohort1Malignant = readRDS("data/Izar_2020/jesslyn_cohort1Malignant_processed.RDS")
cohort1NonMalignant = readRDS("data/Izar_2020/jesslyn_cohort1NonMalignant_processed.RDS")

#load in oxphos genes
oxphosGenes<-read_lines("gene_lists/oxphos.txt", skip = 1)

#filter out genes that are not in the cells 
filterGenes <- c("TOMM70", "ATP6V0C", "ATP5PO", "ATP5PF", "ATP5PD", "ATP5PB", "ATP5MG", "ATP5MF", "ATP5ME", "ATP5MC3", "ATP5MC2", "ATP5MC1", "ATP5F1E", "ATP5F1D", "ATP5F1C", "ATP5F1B", "ATP5F1A")
for (gene in filterGenes){
  oxphosGenes <- oxphosGenes[oxphosGenes!=gene]
}

```

```{r compute average gene expression}
#MALIGNANT CELLS
#For Oxphos Genes
cohort1Malignant <- AddModuleScore(cohort1Malignant, features = list(oxphosGenes), name = "oxphosGenes.Score")
```

```{r find marker genes}
#find marker genes for malignant cells
#based on CLUSTER 
Idents(cohort1Malignant) <- "seurat_clusters"
cohort1Malignant.markers <- FindAllMarkers(cohort1Malignant, only.pps = TRUE, min.pct = 0.25, logfc.threshold = 0.25)
#plot top 5 differential gene expression across malignant clusters 
top5Malignant <- cohort1Malignant.markers %>% group_by(cluster) %>% top_n(n = 5, wt = avg_logFC)
DoHeatmap(cohort1Malignant, features = top5Malignant$gene)
ggsave("cohort1Malignant_top20_differential_genes.jpeg", path="jesslyn_plots", width = 20, height = 15)

#based on SAMPLE
Idents(cohort1Malignant) <- "sample"
cohort1Malignant.markersSamp <- FindAllMarkers(cohort1Malignant, only.pps = TRUE, min.pct = 0.25, logfc.threshold = 0.25)
top5MalignantSamp <- cohort1Malignant.markersSamp %>% group_by(cluster) %>% top_n(n = 5, wt = avg_logFC)
DoHeatmap(cohort1Malignant, features = top5MalignantSamp$gene, size=3)
ggsave("cohort1Malignant_top5_differential_genes_S.jpeg", path="jesslyn_plots/cohort1/Malignant", width = 20, height = 15)

#based on TREATMENT
Idents(cohort1Malignant) <- "treatment.Status"
cohort1Malignant.markersTS <- FindAllMarkers(cohort1Malignant, only.pps = TRUE, min.pct = 0.25, logfc.threshold = 0.25)
```

##ANSWERING RESEARCH QUESTIONS - how does treatment affect the cells?
```{r Questions about # of cycling cells}
#MALIGNANT CELLS
numMalCellsPerTreatmentPerPhase = table(cohort1Malignant$Phase, cohort1Malignant$treatment.Status) %>% as.data.frame() %>% rename(Phase = Var1, Treatment = Var2, numCells = Freq)
ggplot(numMalCellsPerTreatmentPerPhase, aes(x=Treatment, y=numCells, fill=Phase)) + geom_bar(position="fill", stat="identity")
```

```{r Questions about differential gene expression of all genes}
#heatmap for top marker genes across treatment (computed above)
top5MalignantTS <- cohort1Malignant.markersTS %>% group_by(cluster) %>% top_n(n = 5, wt = avg_logFC)
DoHeatmap(cohort1Malignant, features = top5MalignantTS$gene, size=3)
ggsave("cohort1Malignant_top5_differential_genes_TS.jpeg", path="jesslyn_plots/cohort1/Malignant", width = 20, height = 15)

#volcano plot for all genes based on p value grouped by treatment
ggplot(cohort1Malignant.markersTS, aes(x=avg_logFC, y = -log10(p_val_adj)))+ geom_point( )+ ggtitle("Volcano") + xlab("log2 FC") + ylab("-log10 adjusted p-value")
```

```{r Questions about OXPHOS gene expression}
##DE ANALYSIS for oxphos Genes
Idents(cohort1Malignant) <- "treatment.Status"
#compute p values for each oxphos genes across each treatment group
oxphosGenes.markers <- FindAllMarkers(cohort1Malignant, features = oxphosGenes, only.pps = TRUE, min.pct = 0.25, logfc.threshold = 0.25)
top5oxphosMarkers <- oxphosGenes.markers %>% group_by(cluster) %>% top_n(n = 5, wt = avg_logFC)
DoHeatmap(cohort1Malignant, features = oxphosGenes, size=3) # all oxphos genes
DoHeatmap(cohort1Malignant, features = top5oxphosMarkers$gene, size=3) # most variable oxphos genes

#compute p values for oxphos genes between on treatment vs. treatment-naive
oxphosGenesTvsNaive.markers <- FindMarkers(cohort1Malignant, ident.1 = "On-treatment", ident.2 = "Treatment-naive", features = oxphosGenes, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25)
oxphosGenesTvsNaive.markers = rownames_to_column(oxphosGenesTvsNaive.markers, "Gene")

#graph volcano plot for p values 
ggplot(oxphosGenesTvsNaive.markers, aes(x=avg_logFC, y = -log10(p_val_adj))) + 
  geom_point() + 
  geom_text_repel(aes(label = Gene)) +
  geom_hline(yintercept = -log10(0.05), color = "red", linetype = "dashed") +
  geom_vline(xintercept = -1, color = "blue", linetype = "dashed") +
  geom_vline(xintercept = 1, color = "blue", linetype = "dashed") +
  labs(title = "Volcano",
       x = "LFC",
       y = "-log10(FDR)") +
  theme_classic()
ggsave("cohort1Malignant_oxphosGenesTvsNaive.jpeg", path="jesslyn_plots/cohort1/Malignant", height = 12, width = 9)


 #compute p values for oxphos genes between on After 1 cycle of chemotherapy vs. treatment-naive
oxphosGenesCvsNaive.markers <- FindMarkers(cohort1Malignant, ident.1 = "After 1 cycle of chemotherapy", ident.2 = "Treatment-naive", features = oxphosGenes, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25)
#graph volcano plot for p values 
ggplot(oxphosGenesCvsNaive.markers, aes(x=avg_logFC, y = -log10(p_val_adj)))+ geom_point( )+ ggtitle("Volcano") + xlab("log2 FC") + ylab("-log10 adjusted p-value")
```