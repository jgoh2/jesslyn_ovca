---
title: "Izar 2020 PDX and SS2 data specific questions"
author: "Mike Cuoco"
output:
  html_document:
    theme: united
    df_print: kable
date: 'Compiled: `r format(Sys.Date(), "%B %d, %Y")`'
editor_options: 
  chunk_output_type: console
---
***

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  tidy = TRUE,
  tidy.opts = list(width.cutoff = 120),
  message = FALSE,
  warning = FALSE
)
knitr::opts_knit$set(root.dir = here::here())
```

```{r init}
library(tidyverse)
library(plyr)
library(reshape2)
library(Matrix)
library(Seurat)
library(patchwork)
library(glue)
library(beepr)
library(broom)
library(here)
library(msigdbr)

# saving obj setup
proj = "Izar_2020"
date = Sys.Date()

# setup directories
if (!dir.exists(here("mike_plots",proj))){
  dir.create(here("mike_plots",proj))
  dir.create(here("mike_plots",proj,date))
} else if (!dir.exists(here("mike_plots",proj,date))){
  dir.create(here("mike_plots",proj,date))
}

fig.dir = here("mike_plots",proj,date)

# Signatures
ovca_sigs = read_csv("gene_lists/Ovarian_Signatures_combined.csv")[,1:26] %>% 
  as.list() %>%
  lapply(function(x) x[!is.na(x)])
hallmarks = read_lines("gene_lists/hallmarks.txt")
hall_sigs = msigdbr(species = "Homo sapiens", category = "H") %>% 
  filter(gs_name %in% hallmarks) %>% 
  select(gs_name, gene_symbol) %>% 
  dlply("gs_name", function(x) pull(x,gene_symbol))
hall_sigs = msigdbr(species = "Homo sapiens") %>% 
  filter(gs_name %in% c("GO_RESPONSE_TO_ENDOPLASMIC_RETICULUM_STRESS","GO_REGULATION_OF_RESPONSE_TO_ENDOPLASMIC_RETICULUM_STRESS")) %>% 
  select(gs_name, gene_symbol) %>% 
  dlply("gs_name", function(x) pull(x,gene_symbol)) %>%
  c(hall_sigs)
sigs = names(hall_sigs)

# Read in processed SS2 and PDX Seurat objects
ovca_SS2 = list.files(here("data","Izar_2020"), full.names = T) %>% 
  grep("preproc",.,value=T) %>%
  grep("SS2",.,value=T) %>%
  readRDS()
ovca_PDX = list.files(here("data","Izar_2020"), full.names = T) %>% 
  grep("preproc",.,value=T) %>%
  grep("PDX",.,value=T) %>%
  readRDS()
```


# 1. PDX ER stress 

by treatment status and model

```{r ER response vln}
# by signature
feats = c("HALLMARK_UNFOLDED_PROTEIN_RESPONSE","GO_RESPONSE_TO_ENDOPLASMIC_RETICULUM_STRESS")
Idents(ovca_PDX) <- "model_ID"
ovca_PDX$treatment.status = factor(x = ovca_PDX$treatment.status , levels = c("vehicle","MRD","relapse"))

p = VlnPlot(ovca_PDX, features = feats, split.by = "treatment.status", same.y.lims = T, combine = F) 
p = lapply(p, function(x) x + guides(fill=guide_legend("treatment.status")) + labs(x = "model", y = "gene module score") + theme(plot.title = element_text(size = 12)))
ggsave(glue('{fig.dir}/PDX_ERstressreg_vln.png'), p[[1]], width = 10, height = 8)
ggsave(glue('{fig.dir}/PDX_ERstress_vln.png'), p[[2]], width = 10, height = 8)
p = p[[1]] + p[[2]] + patchwork::plot_layout(guides = 'collect')
ggsave(glue('{fig.dir}/PDX_ERboth_vln.png'), p, width = 16, height = 8)

# by gene
feats = c("ATF3","JUN")
p = VlnPlot(ovca_PDX, features = feats, split.by = "treatment.status", same.y.lims = T, combine = F) 
p = lapply(p, function(x) x + guides(fill=guide_legend("treatment.status")) + labs(x = "model", y = "normalized/scaled gene expression") + theme(plot.title = element_text(size = 12)))
ggsave(glue('{fig.dir}/PDX_ATF3_vln.png'), p[[1]], width = 10, height = 8)
ggsave(glue('{fig.dir}/PDX_JUN_vln.png'), p[[2]], width = 10, height = 8)
p = p[[1]] + p[[2]] + patchwork::plot_layout(guides = 'collect')
ggsave(glue('{fig.dir}/PDX_ATF3_JUN_vln.png'), p, width = 16, height = 8)
```

# 2. SS2 Oxphos 

```{r oxphos SS2}
feats =  c("HALLMARK_OXIDATIVE_PHOSPHORYLATION","HALLMARK_GLYCOLYSIS")
Idents(ovca_SS2) = "Patient"
ovca_SS2@active.ident = factor(x = ovca_SS2@active.ident , levels = c(sort(unique(ovca_SS2$Patient))))

for (i in c("treatment.status","Time")){
  p = subset(ovca_SS2, subset = cell.type == "Malignant") %>%
    VlnPlot(features = feats, split.by = i, combine = F)
  p = lapply(p, function(x) x + guides(fill=guide_legend(i)) + labs(x = "patient", y = "gene module score") + theme(plot.title = element_text(size = 12)))
  ggsave(glue('{fig.dir}/SS2_oxphos_{i}_vln.png'), p[[1]], width = 10, height = 8)
  ggsave(glue('{fig.dir}/SS2_glycol_{i}_vln.png'), p[[2]], width = 10, height = 8)
  p = p[[1]] + p[[2]] + patchwork::plot_layout(guides = 'collect') + patchwork::plot_annotation(title = "SS2 data: Malignant Cells Only")
  ggsave(glue('{fig.dir}/SS2_metab_{i}_vln.png'), p, width = 16, height = 8)
}

```
