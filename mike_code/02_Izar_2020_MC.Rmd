---
title: "Izar 2020 scRNAseq data downstream"
author: "Mike Cuoco"
output:
  html_document:
    theme: united
    df_print: kable
date: 'Compiled: `r format(Sys.Date(), "%B %d, %Y")`'
editor_options: 
  chunk_output_type: console
---
***

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  tidy = TRUE,
  tidy.opts = list(width.cutoff = 120),
  message = FALSE,
  warning = FALSE
)
knitr::opts_knit$set(root.dir = here::here())
```

```{r init}
library(tidyverse)
library(plyr)
library(reshape2)
library(Matrix)
library(Seurat)
# library(infercnv)
library(patchwork)
library(glue)
library(beepr)
library(broom)
library(here)

# saving obj setup
proj = "Izar_2020"
date = Sys.Date()

# setup directories
if (!dir.exists(here("mike_plots",proj))){
  dir.create(here("mike_plots",proj))
  dir.create(here("mike_plots",proj,date))
} else if (!dir.exists(here("mike_plots",proj,date))){
  dir.create(here("mike_plots",proj,date))
}

fig.dir = here("mike_plots",proj,date)

# Signatures
ovca_sigs = read_csv("gene_lists/Ovarian_Signatures_combined.csv")[,1:26] %>% 
  as.list() %>%
  lapply(function(x) x[!is.na(x)])
sigs = paste0(names(ovca_sigs), 1:length(names(ovca_sigs)))

# Read in most recently processed Seurat objects
ovca_10x = list.files(here("data","Izar_2020"), full.names = T) %>% 
  grep("preproc",.,value=T) %>%
  grep("10x",.,value=T) %>%
  readRDS()
ovca_SS2 = list.files(here("data","Izar_2020"), full.names = T) %>% 
  grep("preproc",.,value=T) %>%
  grep("SS2",.,value=T) %>%
  readRDS()
ovca_PDX = list.files(here("data","Izar_2020"), full.names = T) %>% 
  grep("preproc",.,value=T) %>%
  grep("PDX",.,value=T) %>%
  readRDS()
```

```{r tsneplot, fig.height=5, fig.width=7}
list = list("10x" = list("ovca_10x" = ovca_10x,
                          "meta_features" = c("patient","sample.ID","time","clst",
                                              "seurat_clusters","Phase","cell.type","treatment.status")),
            "SS2" = list("ovca_SS2" = ovca_SS2,
                         "meta_features" = c("Patient","Time","clst",
                                             "seurat_clusters", "Phase", "treatment.status")),
            "PDX" = list("ovca_PDX" = ovca_PDX,
                         "meta_features" = c("mouse_ID","model_ID",
                                             "treatment.status","Phase")))

for (j in 1:length(list)){
  p_list = vector(mode = "list",length = length(list[[j]][["meta_features"]]))
  names(p_list) = list[[j]][["meta_features"]]
  for (i in list[[j]][["meta_features"]]) {
   p_list[[i]] = DimPlot(object = list[[j]][[1]], reduction = 'umap', group.by = i) + 
     labs(color = i) +
    plot_annotation(glue("{gsub('_',' ',proj)} {names(list)[j]}: {ncol(list[[j]][[1]]@assays$RNA@scale.data)} cells {nrow(list[[j]][[1]]@assays$RNA@scale.data)} genes"), caption = date())
   print(p_list[[i]])
   ggsave(glue('{fig.dir}/{names(list)[j]}_umap_{i}.png'), width = 7, height = 7)
   if (i == list[[j]][["meta_features"]][1]){plot = p_list[[i]]}
   else {plot = plot + p_list[[i]]}
  }
  ggsave(glue('{fig.dir}/{names(list)[j]}_umap_all-meta.png'),plot, width = 15, height = 10)
}

beep(4)
```

```{r}
Idents(ovca_10x) <- "treatment.status"
ovca_10x@active.ident = factor(x = ovca_10x@active.ident , levels = c("Treatment-naïve","After 1 cycle of chemotherapy","On-treatment"))
Idents(ovca_PDX) <- "treatment.status"
ovca_PDX@active.ident = factor(x = ovca_PDX@active.ident , levels = c("vehicle","MRD","relapse"))
for (i in sigs){
  VlnPlot(subset(ovca_10x, subset = cell.type == "Malignant"), features = i)
  ggsave(glue('{fig.dir}/10x_sig{i}_malig_ts.png'), width = 10, height = 7)
  Idents(ovca_SS2) <- "treatment.status"
  ovca_SS2@active.ident = factor(x = ovca_SS2@active.ident , levels = c("Treatment-naïve","On-treatment"))
  VlnPlot(ovca_SS2, features = i)
  ggsave(glue('{fig.dir}/SS2_sig{i}_ts.png'), width = 10, height = 7)
  Idents(ovca_SS2) <- "Time"
  ovca_SS2@active.ident = factor(x = ovca_SS2@active.ident , levels = c("0","1","2","3","4","5"))
  VlnPlot(ovca_SS2, features = i)
  ggsave(glue('{fig.dir}/SS2_sig{i}_time.png'), width = 10, height = 7)
  VlnPlot(ovca_PDX, features = i)
  ggsave(glue('{fig.dir}/PDX_sig{i}_time.png'), width = 10, height = 7)
}


DotPlot(subset(ovca_10x, subset = cell.type == "Malignant"), features = sigs) + coord_flip() + RotatedAxis()  + ggtitle("10X")
ggsave(glue('{fig.dir}/10x_sigs_malig_ts_dot.png'), width = 10, height = 12) 
DotPlot(ovca_PDX, features = sigs) + coord_flip() + RotatedAxis() + ggtitle("PDX")
ggsave(glue('{fig.dir}/PDX_sigs_malig_ts_dot.png'), width = 10, height = 12)
Idents(ovca_SS2) <- "treatment.status"
ovca_SS2@active.ident = factor(x = ovca_SS2@active.ident , levels = c("Treatment-naïve","On-treatment"))
DotPlot(ovca_SS2, features = sigs) + coord_flip() + RotatedAxis() + ggtitle("SS2")
ggsave(glue('{fig.dir}/SS2_sigs_ts_dot.png'), width = 10, height = 12)
beep(4)
```

```{r}
div = length(celltype_genes$Gene)%/%16
Idents(ovca_10x) <- "treatment.status"
Idents(ovca_SS2) <- "Time"
list = list("datasets" = list(ovca_10x,ovca_SS2,ovca_PDX),
            "names" = c("10x","SS2","PDX"),
            "featuresets" = sigs)
for(i in 1:div){
  list[["featuresets"]][[i]] = celltype_genes$Gene[(1+(16*(i-1))):(16+(16*(i-1)))]
}

list$featuresets[[div+1]] = c("percent.mt","n.exp.hkgenes")

for (i in 1:length(list[["datasets"]])){
  for (j in 1:length(list[["featuresets"]])) {
    p1 = FeaturePlot(object = list[["datasets"]][[i]], features = list[["featuresets"]][[j]]) +
      plot_annotation(title = glue("{gsub('_',' ',proj)} {list[['names']][i]}"),
                      caption = date())
    if (length(list[["featuresets"]][[j]]) > 6) {
      print(p1)
      ggsave(glue("{fig.dir}/{list[['names']][i]}_umap_features{j}.png"), width = 16, height = 16)
    } else {
      ggsave(glue("{fig.dir}/{list[['names']][i]}_umap_features_{list[['featuresets']][j]}.png"), width = 7, height = 7)
    }
  }
}

beep(4)
```




```{r clusterHeatmap, fig.height=8, fig.width=15}
pbmc.markers %>% group_by(cluster) %>% top_n(n = 10, wt = avg_logFC) -> top10
DoHeatmap(object = pbmc, features = top10$gene) + NoLegend()
```
